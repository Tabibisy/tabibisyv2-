<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ù…ÙˆÙ„Ù‘Ø¯ ÙˆØµÙØ© Ø·Ø¨ÙŠØ© â€” Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ PDF Ù„Ù„Ø¨ÙˆØª</title>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {font-family: sans-serif; background:#f5f7fb; margin:0; padding:20px;}
    .card {background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); margin-bottom:16px;}
    button {padding:10px 16px; border:none; border-radius:8px; font-weight:600; cursor:pointer;}
    .btn {background:#1e88e5; color:#fff;}
    .btn.secondary {background:#374151; color:#fff;}
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸ“„ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„ÙˆØµÙØ©</h2>
    <div id="rxTableArea">
      <!-- Ù‡Ù†Ø§ ÙŠØ¬ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„ÙŠ ÙŠÙˆÙ„Ø¯Ù‡ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
      <table border="1" width="100%" cellpadding="8">
        <tr><th>ğŸ’Š Ø§Ù„Ø¯ÙˆØ§Ø¡</th><th>Ø§Ù„Ø´ÙƒÙ„</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th></tr>
        <tr><td>Amoxicillin</td><td>Tablet</td><td>500 mg</td></tr>
        <tr><td>Paracetamol</td><td>Tablet</td><td>500 mg</td></tr>
      </table>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="downloadPDF" class="btn">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ PDF</button>
      <button id="sendToBot" class="btn secondary">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ PDF Ù„Ù„Ø¨ÙˆØª</button>
    </div>
  </div>

  <script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  // Ø²Ø± ØªÙ†Ø²ÙŠÙ„ PDF Ù…Ø­Ù„ÙŠ
  document.getElementById("downloadPDF").onclick = () => {
    const element = document.getElementById("rxTableArea");
    const opt = {
      margin: 10,
      filename: "prescription.pdf",
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  };

  // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨ÙˆØª
  document.getElementById("sendToBot").onclick = async () => {
    const user = tg.initDataUnsafe?.user;
    if (!user) {
      alert("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…");
      return;
    }

    // ØªÙˆÙ„ÙŠØ¯ PDF Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const element = document.getElementById("rxTableArea");
    const opt = {
      margin: 10,
      filename: "prescription.pdf",
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf("blob");
    const base64Data = await blobToBase64(pdfBlob);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª Ø¹Ø¨Ø± sendData
    tg.sendData(JSON.stringify({
      user_id: user.id,
      username: user.username,
      pdf: base64Data
    }));

    alert("ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙØ© Ù„Ù„Ø¨ÙˆØª");
  };

  // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Blob -> Base64
  function blobToBase64(blob) {
    return new Promise((resolve, _) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(",")[1]);
      reader.readAsDataURL(blob);
    });
  }
  </script>
</body>
</html>
