<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ ÙˆØµÙØ© Ø·Ø¨ÙŠØ© â€” Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    body {font-family:'Tajawal',sans-serif;background:#f5f7fb;margin:0;color:#111827;}
    .wrap{max-width:980px;margin:28px auto;padding:16px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px;margin-bottom:16px;overflow:hidden;}
    h1{margin:0 0 10px;font-size:20px;color:#1e88e5;}
    h2{margin:0 0 10px;font-size:16px;color:#0f172a;}
    .grid{display:grid;gap:12px;}
    .cols-2{grid-template-columns:1fr 1fr;}
    label{display:block;font-size:13px;margin-bottom:6px;color:#0f172a;}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;box-sizing:border-box;}
    textarea{min-height:80px;resize:vertical;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{padding:10px 16px;background:#1e88e5;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;}
    .btn.secondary{background:#374151;}
    .muted{color:#6b7280;font-size:13px;}
    .notice{background:#fff7ed;border-left:4px solid #f59e0b;padding:10px;border-radius:6px;color:#92400e;font-size:13px;margin-top:10px;}
    .danger{background:#fff0f0;border-left:4px solid #ef4444;color:#b91c1c;padding:10px;border-radius:6px;font-size:13px;margin-top:10px;}
    pre{white-space:pre-wrap;background:#0f172a;color:#f8fafc;padding:12px;border-radius:8px;font-size:13px;overflow:auto;}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(0,0,0,0.08);border-top-color:#1e88e5;border-radius:50%;animation:spin 1s linear infinite;margin-left:6px;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØµÙØ© */
    .table-container{overflow-x:auto;}
    .rx-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      border-radius: 10px;
      overflow: hidden;
    }
    .rx-table th {
      background: #1e88e5;
      color: #fff;
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    .rx-table td {
      padding: 10px;
      border: 1px solid #e5e7eb;
      vertical-align: top;
    }
    .rx-table tr:nth-child(even) {
      background: #f9fafb;
    }
    .conf-high { color: #16a34a; font-weight: bold; }
    .conf-moderate { color: #f97316; font-weight: bold; }
    .conf-low { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ù…ÙˆÙ„Ù‘Ø¯ ÙˆØµÙØ© Ø·Ø¨ÙŠØ© â€” Ù…Ø³Ø§Ø¹Ø¯Ø© Ø°ÙƒÙŠØ©</h1>
      <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© ØªÙˆÙ„Ù‘Ø¯ <strong>Ù…Ø³ÙˆØ¯Ø© ÙˆØµÙØ©</strong> ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨.</p>
    </div>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div class="card">
      <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h2>
      <div class="grid cols-2">
        <div><label>Ø§Ù„Ø¹Ù…Ø± *</label><input id="p_age" type="number" min="0"></div>
        <div><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØº)</label><input id="p_weight" type="number" min="0"></div>
      </div>
      <div class="grid cols-2" style="margin-top:12px;">
        <div>
          <label>Ø§Ù„Ø¬Ù†Ø³ *</label>
          <select id="p_gender">
            <option value="">Ø§Ø®ØªØ±</option><option value="Male">Ø°ÙƒØ±</option><option value="Female">Ø£Ù†Ø«Ù‰</option>
          </select>
        </div>
        <div>
          <label>Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ©</label>
          <select id="p_status">
            <option value="">Ù„Ø§ Ø´ÙŠØ¡</option><option value="pregnant">Ø­Ø§Ù…Ù„</option><option value="breastfeeding">Ù…Ø±Ø¶Ø¹</option>
          </select>
        </div>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div><label>Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©</label><input id="p_conditions" type="text"></div>
        <div><label>ØªØ­Ø³Ø³ Ø¯ÙˆØ§Ø¦ÙŠ</label><input id="p_allergy" type="text"></div>
        <div><label>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><textarea id="p_current"></textarea></div>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ´Ø®ÙŠØµ -->
    <div class="card">
      <h2>Ø§Ù„ØªØ´Ø®ÙŠØµ / Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù„Ø§Ø¬</h2>
      <textarea id="p_diagnosis"></textarea>
      <div class="row" style="margin-top:12px;">
        <button id="generateBtn" class="btn">ğŸš€ ØªÙˆÙ„ÙŠØ¯ ÙˆØµÙØ©</button>
        <button id="clearBtn" class="btn secondary" type="button">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        <div id="status" style="margin-left:auto;align-self:center;"></div>
      </div>
      <div class="notice">âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø³ÙˆØ¯Ø© â€” ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨.</div>
    </div>

    <!-- Ø§Ù„ÙˆØµÙØ© -->
    <div id="rxCard" class="card" style="display:none;">
      <h2>ğŸ“„ Ù…Ø³ÙˆØ¯Ø© Ø§Ù„ÙˆØµÙØ©</h2>
      <div id="rxMeta" class="muted"></div>
      <div class="table-container" id="rxTableArea"></div>
      <div id="rxRaw" style="display:none;margin-top:10px;"></div>
      <div class="row" style="margin-top:12px;">
        <button id="copyRx" class="btn">ğŸ“‹ Ù†Ø³Ø®</button>
        <button id="printRx" class="btn secondary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
      <div id="rxWarning" class="danger" style="display:none;">âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØµÙØ© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ ÙÙ‚Ø· ÙˆÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ø·Ø¨ÙŠØ§Ù‹.</div>
    </div>
  </div>

  <script>
    const genBtn=document.getElementById("generateBtn");
    const statusEl=document.getElementById("status");
    const rxCard=document.getElementById("rxCard");
    const rxTableArea=document.getElementById("rxTableArea");
    const rxRaw=document.getElementById("rxRaw");
    const rxMeta=document.getElementById("rxMeta");
    const copyRx=document.getElementById("copyRx");
    const printRx=document.getElementById("printRx");

    function setStatus(on,msg="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„..."){
      statusEl.innerHTML=on?`<span class="spinner"></span> ${msg}`:"";
      genBtn.disabled=on;
    }

    document.getElementById("clearBtn").onclick=()=>{document.querySelectorAll("input,textarea,select").forEach(el=>el.value="");rxCard.style.display="none";};

    genBtn.onclick=async()=>{
      const age=document.getElementById("p_age").value.trim();
      const gender=document.getElementById("p_gender").value;
      const diagnosis=document.getElementById("p_diagnosis").value.trim();
      if(!age||!gender||!diagnosis){alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„Ø¬Ù†Ø³ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ");return;}

      setStatus(true);
      rxCard.style.display="block";
      rxTableArea.innerHTML="<p>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</p>";
      rxRaw.style.display="none";

      const weight=document.getElementById("p_weight").value.trim();
      const status=document.getElementById("p_status").value;
      const conditions=document.getElementById("p_conditions").value.trim();
      const allergy=document.getElementById("p_allergy").value.trim();
      const current=document.getElementById("p_current").value.trim();

      const prompt=`Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø·Ø¨ÙŠ. Ø£Ø¹Ø·Ù†ÙŠ ÙÙ‚Ø· JSON Ù„Ù…ØµÙÙˆÙØ© Ø£Ø¯ÙˆÙŠØ©.
[
 { "name":"Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡","trade_name":"","form":"","dose":"","frequency":"","duration":"","instructions":"","confidence":"High/Moderate/Low" }
]
Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶: Ø§Ù„Ø¹Ù…Ø±:${age}ØŒ Ø§Ù„ÙˆØ²Ù†:${weight||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}ØŒ Ø§Ù„Ø¬Ù†Ø³:${gender}ØŒ Ø­Ø§Ù„Ø©:${status||"Ù„Ø§"}ØŒ Ø£Ù…Ø±Ø§Ø¶:${conditions||"Ù„Ø§"}ØŒ ØªØ­Ø³Ø³:${allergy||"Ù„Ø§"}ØŒ Ø£Ø¯ÙˆÙŠØ©:${current||"Ù„Ø§"}ØŒ Ø§Ù„ØªØ´Ø®ÙŠØµ:${diagnosis}`;

      try{
        const completion=await puter.ai.chat([{role:"user",content:prompt}],{model:"gpt-5"});
        let raw="";
        if(completion?.message?.content){raw=completion.message.content;}
        else if(completion?.output_text){raw=completion.output_text;}
        else{raw=JSON.stringify(completion);}
        const match=raw.match(/\[.*\]/s);
        let meds=null;
        if(match){try{meds=JSON.parse(match[0]);}catch{}}

        if(Array.isArray(meds)){
          rxMeta.textContent="âœ… ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ â€” Ø±Ø§Ø¬Ø¹Ù‡Ø§ Ø·Ø¨ÙŠØ¨ÙŠØ§Ù‹";
          rxTableArea.innerHTML=renderTable(meds);
          rxRaw.style.display="none";
          copyRx.dataset.json=JSON.stringify(meds,null,2);
        }else{
          rxMeta.textContent="âš ï¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù… ÙŠÙØ±Ø¬Ø¹ JSON ØµØ§Ù„Ø­ â€” Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù…:";
          rxTableArea.innerHTML="";
          rxRaw.style.display="block";
          rxRaw.innerHTML="<pre>"+escapeHtml(raw)+"</pre>";
        }
      }catch(e){
        rxMeta.textContent="âš ï¸ Ø®Ø·Ø£: "+e.message;
        rxTableArea.innerHTML="";
      }finally{setStatus(false);}
    };

    function renderTable(meds){
      let html="<table class='rx-table'><thead><tr>" +
        "<th>ğŸ’Š Ø§Ù„Ø¯ÙˆØ§Ø¡</th><th>Ø§Ù„Ø´ÙƒÙ„</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th>" +
        "<th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>ØªØ¹Ù„ÙŠÙ…Ø§Øª</th><th>Ø§Ù„Ø«Ù‚Ø©</th>" +
        "</tr></thead><tbody>";
      meds.forEach(m=>{
        let confClass="conf-low";
        if((m.confidence||"").toLowerCase().includes("high")) confClass="conf-high";
        else if((m.confidence||"").toLowerCase().includes("moderate")) confClass="conf-moderate";
        html+=`<tr>
          <td><strong>${escapeHtml(m.name||"")}</strong>${m.trade_name?("<div class='muted'>"+escapeHtml(m.trade_name)+"</div>"):""}</td>
          <td>${escapeHtml(m.form||"")}</td>
          <td>${escapeHtml(m.dose||"")}</td>
          <td>${escapeHtml(m.frequency||"")}</td>
          <td>${escapeHtml(m.duration||"")}</td>
          <td>${escapeHtml(m.instructions||"")}</td>
          <td class="${confClass}">${escapeHtml(m.confidence||"")}</td>
        </tr>`;
      });
      html+="</tbody></table>";
      return html;
    }

    function escapeHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
    copyRx.onclick=()=>{navigator.clipboard.writeText(copyRx.dataset.json||"").then(()=>alert("ğŸ“‹ ØªÙ… Ø§Ù„Ù†Ø³Ø®"))};
    printRx.onclick=()=>{window.print();};
  </script>
</body>
</html>
