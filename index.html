<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>مولّد وصفة طبية — مع إرسال PDF للبوت</title>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {font-family: sans-serif; background:#f5f7fb; margin:0; padding:20px;}
    .card {background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); margin-bottom:16px;}
    button {padding:10px 16px; border:none; border-radius:8px; font-weight:600; cursor:pointer;}
    .btn {background:#1e88e5; color:#fff;}
    .btn.secondary {background:#374151; color:#fff;}
  </style>
</head>
<body>
  <div class="card">
    <h2>📄 مسودة الوصفة</h2>
    <div id="rxTableArea">
      <!-- هنا يجي الجدول اللي يولده السكربت -->
      <table border="1" width="100%" cellpadding="8">
        <tr><th>💊 الدواء</th><th>الشكل</th><th>الجرعة</th></tr>
        <tr><td>Amoxicillin</td><td>Tablet</td><td>500 mg</td></tr>
        <tr><td>Paracetamol</td><td>Tablet</td><td>500 mg</td></tr>
      </table>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="downloadPDF" class="btn">📥 تنزيل PDF</button>
      <button id="sendToBot" class="btn secondary">📤 إرسال PDF للبوت</button>
    </div>
  </div>

  <script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  // زر تنزيل PDF محلي
  document.getElementById("downloadPDF").onclick = () => {
    const element = document.getElementById("rxTableArea");
    const opt = {
      margin: 10,
      filename: "prescription.pdf",
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  };

  // زر إرسال للبوت
  document.getElementById("sendToBot").onclick = async () => {
    const user = tg.initDataUnsafe?.user;
    if (!user) {
      alert("❌ لم أستطع قراءة بيانات المستخدم من تليجرام");
      return;
    }

    // توليد PDF من الجدول
    const element = document.getElementById("rxTableArea");
    const opt = {
      margin: 10,
      filename: "prescription.pdf",
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf("blob");
    const base64Data = await blobToBase64(pdfBlob);

    // إرسال البيانات للبوت عبر sendData
    tg.sendData(JSON.stringify({
      user_id: user.id,
      username: user.username,
      pdf: base64Data
    }));

    alert("📤 تم إرسال الوصفة للبوت");
  };

  // دالة تحويل Blob -> Base64
  function blobToBase64(blob) {
    return new Promise((resolve, _) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(",")[1]);
      reader.readAsDataURL(blob);
    });
  }
  </script>
</body>
</html>
