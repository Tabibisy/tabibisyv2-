<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <title>ุงุฑุณุงู PDF ูุจุงุดุฑุฉ ููุจูุช (ุชุฌุฑูุจู - ุบูุฑ ุขูู)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body{font-family:Tahoma, Arial; padding:18px; background:#f6f7fb}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn{background:#1e88e5;color:#fff}
    .warn{color:#b91c1c;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h3>ุงุฎุชุจุงุฑ: ุชูููุฏ PDF ูุงุฑุณุงูู ูุจุงุดุฑุฉ ููุจูุช (ุชุฌุฑูุจู)</h3>

    <!-- ูุซุงู ุนูู ูุญุชูู ุงููุตูุฉ -->
    <div id="rxTableArea" style="margin:12px 0;">
      <table border="1" width="100%" cellpadding="6">
        <thead><tr><th>ุงูุฏูุงุก</th><th>ุงูุฌุฑุนุฉ</th><th>ุชุนูููุงุช</th></tr></thead>
        <tbody>
          <tr><td>ููุณููููุณูู</td><td>3 ุบ (ููุณ ูุงุญุฏ)</td><td>ุฌุฑุนุฉ ูุงุญุฏุฉุ ุจุนุฏ ุฃุฎุฐ ุนููุฉ ุจูู</td></tr>
          <tr><td>ุจุงุฑุงุณูุชุงููู</td><td>500 mg</td><td>ุนูุฏ ุงูุญุงุฌุฉ ููุญูู</td></tr>
        </tbody>
      </table>
    </div>

    <div style="display:flex;gap:8px">
      <button id="downloadPDF" class="btn">๐ฅ ุชูุฒูู PDF</button>
      <button id="sendDirect" class="btn" style="background:#16a34a">๐ค ุฅุฑุณุงู ูุจุงุดุฑ (fetch)</button>
    </div>

    <p class="warn">
      ุชูุจูู: ูุฐู ุงูุชุฌุฑุจุฉ **ุชูุดู ุงูุชููู** ู ูุฏ ุชูุดู ุจุณุจุจ CORS. ูุง ุชูุดุฑ ูุฐุง ุงูููุฏ ุนูู ุตูุญุงุช ุนุงูุฉ.
    </p>

    <pre id="log" style="background:#0f172a;color:#f8fafc;padding:8px;border-radius:6px;display:none"></pre>
  </div>

<script>
/* ======== ุฅุนุฏุงุฏุงุช ุงูุชุฌุฑุจุฉ (ุถุน ุชููู ุงูุจูุช ููุง) ======== */
const BOT_TOKEN = "7590799340:AAF_VqeXNX3VDXWMionBHOfaGXXpCpCwG04"; // <<-- **ุบูุฑ ุขูู** ุฅู ุชุฑูุชู ููุง ููุนุงูุฉ
/* ===================================================== */

const rxEl = document.getElementById("rxTableArea");
const logEl = document.getElementById("log");
function log(msg){ logEl.style.display="block"; logEl.textContent += msg + "\\n"; }

/* ุชูุฒูู PDF ูุญูู */
document.getElementById("downloadPDF").onclick = () => {
  const opt = {
    margin: 10,
    filename: 'prescription.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(rxEl).save();
};

/* ุฏุงูุฉ ุชุญููู Blob -> File (ูู FormData) */
function blobToFile(theBlob, fileName){
  // Blob -> File (ูุทููุจ ุฃุญูุงููุง ูุชุณููุฉ ุงูููู ูู FormData)
  return new File([theBlob], fileName, { type: theBlob.type });
}

/* ุงุฑุณุงู ูุจุงุดุฑ ุฅูู Bot API ุนุจุฑ fetch */
document.getElementById("sendDirect").onclick = async () => {
  try{
    // ุชูููุฏ PDF ูู Blob
    const opt = {
      margin: 10, filename: 'prescription.pdf',
      image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'}
    };
    // html2pdf().from(...).save() -> ููู ููุง ูุญุชุงุฌ ุงูู blob
    const worker = html2pdf().set(opt).from(rxEl);

    // html2pdf v0.10 ูููุฑ outputPdf("blob") async
    const pdfBlob = await worker.outputPdf('blob');

    // ุชุญููู ุฅูู File (ููุณ ุถุฑูุฑููุง ููู ูุณูู ุชุณููุฉ ุงูููู)
    const pdfFile = blobToFile(pdfBlob, "prescription.pdf");

    // ูุญุงูู ูุฑุงุกุฉ user id ูู WebApp (ูู ููุฌูุฏ)
    let chatId = null;
    try{
      const tg = window.Telegram?.WebApp;
      const user = tg?.initDataUnsafe?.user;
      if(user && user.id) chatId = user.id;
      else {
        // ุฅู ูู ููู WebApp ุฃู ูู ููุนุทู user: ุงุทูุจ ูู ุงููุณุชุฎุฏู ุฅุฏุฎุงู chat_id ูุฏููุงู
        chatId = prompt("ูู ูุชู ุงููุดู ุนู user.id ุชููุงุฆูุงู. ุฃุฏุฎู chat_id (ุฑูู) ูููุณุชุฎุฏู/ุงูุฏุฑุฏุดุฉ:");
        if(!chatId){ alert("ูุทููุจ chat_id ููุงุฑุณุงู."); return; }
      }
    }catch(e){
      chatId = prompt("ุฃุฏุฎู chat_id (ุฑูู) ูููุณุชุฎุฏู/ุงูุฏุฑุฏุดุฉ:");
      if(!chatId){ alert("ูุทููุจ chat_id ููุงุฑุณุงู."); return; }
    }

    // ุชุฌููุฒ FormData
    const fd = new FormData();
    fd.append("chat_id", String(chatId));
    fd.append("document", pdfFile, "prescription.pdf");

    // ููุทุฉ ุงูููุงูุฉ
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`;

    log("โณ ุงุฑุณุงู ุงูู: " + url);
    const res = await fetch(url, { method: "POST", body: fd });

    // ุชุญูู ูู ุงูุงุณุชุฌุงุจุฉ
    const result = await res.json().catch(()=>({ok:false, description:"non-json response"}));
    if(res.ok && result && result.ok){
      log("โ ุชู ุงูุงุฑุณุงู ุจูุฌุงุญ. message_id: " + (result.result && result.result.message_id));
      alert("ุชู ุงูุฅุฑุณุงู โ ุชุญูู ูู ุฏุฑุฏุดุฉ ุงูุชููุฌุฑุงู.");
    } else {
      log("โ ูุดู ุงูุฅุฑุณุงู. HTTP: " + res.status + " โ " + JSON.stringify(result));
      alert("ูุดู ุงูุฅุฑุณุงู โ ุฑุงุฌุน ุงูููุบ ููุฎุทุฃ. ุบุงูุจูุง ูุดููุฉ CORS ุฃู ุชููู/chat_id ุบูุฑ ุตุญูุญ.");
    }
  }catch(err){
    console.error(err);
    log("ุฎุทุฃ ุงุณุชุซูุงุฆู: " + (err && err.message));
    alert("ุญุฏุซ ุฎุทุฃ: " + (err && err.message));
  }
};
</script>
</body>
</html>
